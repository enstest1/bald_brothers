<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bald Br√∂therh√∂√∂d</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #0d0d0d;
      color: #e3e3e3;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    /* Fullscreen background video */
    #bgvid {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      object-fit: cover;
      z-index: -2;
      filter: brightness(0.4) blur(1px);
    }
    .wrap { max-width: 1100px; margin: auto; padding: 2rem 1rem; position: relative; z-index: 1; }
    /* Banner video */
    .banner {
      width: 100%;
      max-width: 900px;
      margin: 0 auto 2rem auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 32px #000a;
      border: 3px solid #ffe600;
      position: relative;
    }
    .banner video { width: 100%; display: block; }
    /* Commandment section */
    .commandment {
      background: #131313cc;
      border: 2px solid #ffe600;
      border-radius: 8px;
      margin: 2rem 0;
      padding: 2rem;
      text-align: center;
    }
    .commandment h2 {
      font-family: 'UnifrakturMaguntia', cursive;
      font-size: 2.25rem;
      color: #ffe600;
      margin-bottom: 1rem;
    }
    .commandment p { max-width: 36ch; margin: auto; }
    /* Poll section */
    .poll {
      background: #181818cc;
      border-radius: 10px;
      padding: 2rem;
      margin: 2rem 0;
      box-shadow: 0 2px 12px #0005;
      text-align: center;
    }
    .poll video { width: 180px; border-radius: 8px; margin-bottom: 1rem; }
    .poll button {
      background: #ffe600;
      color: #222;
      font-family: 'Press Start 2P', monospace;
      font-size: 1.1rem;
      padding: 0.7em 2em;
      border: none;
      border-radius: 6px;
      margin: 0 1em;
      cursor: pointer;
      box-shadow: 0 2px 8px #0003;
      transition: background 0.2s;
    }
    .poll button:hover { background: #fff200; }
    /* Poll Results Styling */
    .poll-results {
      margin: 1rem 0;
      padding: 1rem;
      background: #222c;
      border-radius: 8px;
    }
    
    .result-bar {
      display: flex;
      height: 30px;
      margin: 1rem 0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .yes-bar, .no-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-weight: bold;
      transition: width 0.3s ease;
      min-width: 60px;
    }
    
    .yes-bar {
      background: #4CAF50;
    }
    
    .no-bar {
      background: #f44336;
    }
    
    .total-votes {
      text-align: center;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #888;
    }
    /* Story area */
    .story {
      background: #222c;
      border-radius: 12px;
      border: 2px solid #ffe600;
      margin: 2rem 0;
      padding: 2rem;
      min-height: 120px;
      text-align: center;
      font-size: 1.2rem;
      position: relative;
    }
    /* Footer */
    footer { text-align:center; font-size:.875rem; margin:3rem 0 1rem; color:#888; }
    a { color:#ffe600; }
  </style>
</head>
<body>
  <!-- Animated background video -->
  <video id="bgvid" src="./images/background.mp4" autoplay loop muted playsinline></video>
  <div class="wrap">
    <!-- Banner video header -->
    <div class="banner">
      <video src="./images/bannertext.mp4" autoplay loop muted playsinline></video>
    </div>
    <!-- Commandment section -->
    <section class="commandment">
      <h2>Br√∂ther Commandment #1</h2>
      <p><em>ùïøùñçùñîùñö ùñòùñçùñÜùñëùñô ùïΩùñäùñòùñïùñäùñàùñô ùñôùñçùñä ùï≠ùñÜùñëùñâ.</em><br><br>
         The bare crown is sacred. Let no wig, cap, or illusion defile it. From the bald head springs all truth.
      </p>
    </section>
    <!-- Poll section with voting animation -->
    <section class="poll" id="poll-section">
      <video src="./images/yesno.mp4" autoplay loop muted playsinline></video>
      <div id="current-poll">
        <h2>Loading current poll...</h2>
      </div>
    </section>
    <!-- Story area -->
    <section class="story" id="story-section">
      <h2 id="story-heading">The story begins soon...</h2>
      <div id="countdown" style="font-size:1.5rem;margin:1rem 0;"></div>
      <div id="chapter-content" style="display:none;"></div>
    </section>
    <!-- Footer -->
    <footer>
      ¬© 2025 Bald Br√∂therh√∂√∂d. Artwork &amp; lore licensed for community remix.<br/>
      Built with üë®‚Äçü¶≤ using Bootoshi&nbsp;Story Engine.
    </footer>
  </div>
  <script>
    const pollSection = document.getElementById('poll-section');
    const storySection = document.getElementById('story-section');
    const storyHeading = document.getElementById('story-heading');
    const chapterContent = document.getElementById('chapter-content');
    const currentPollDiv = document.getElementById('current-poll');

    let currentPoll = null;
    let pollInterval;

    // --- Core Functions ---

    async function fetchLatestChapter() {
        try {
            const response = await fetch('/api/beats/latest');
            const data = await response.json();
            if (!response.ok) {
                if(response.status === 404) {
                    storyHeading.textContent = 'The Story Begins...';
                    chapterContent.innerHTML = `<p>${data.body}</p>`;
                } else {
                   throw new Error(data.error || 'Failed to load chapter');
                }
            } else {
                storyHeading.textContent = data.title;
                chapterContent.innerHTML = `<p>${data.body.replace(/\n/g, '<br>')}</p>`;
                // Add a note if the fallback chapter is shown
                if (data.body && data.body.includes('The Bald Brothers continue their journey, but the details are lost to legend.')) {
                    chapterContent.innerHTML += '<p style="color:orange;"><em>(AI is recharging. This is a fallback chapter.)</em></p>';
                }
            }
            storySection.style.display = 'block';
        } catch (error) {
            console.error('Error fetching chapter:', error);
            storyHeading.textContent = 'Error Loading Story';
            chapterContent.innerHTML = '<p>Could not load the latest chapter. Please refresh the page.</p>';
        }
    }

    async function fetchOpenPoll() {
        try {
            const response = await fetch('/polls/open');
            const data = await response.json();
            
            if (data.poll) {
                if (pollInterval) clearInterval(pollInterval); // Stop polling once we find a poll
                currentPoll = data.poll;
                displayPoll(currentPoll);
            } else {
                // If no poll is active, keep trying every 5 seconds
                currentPollDiv.innerHTML = '<h2>Searching for the next path...</h2>';
                if (!pollInterval) {
                   pollInterval = setInterval(fetchOpenPoll, 5000);
                }
            }
        } catch (error) {
            console.error('Error loading poll:', error);
            currentPollDiv.innerHTML = '<h2>Error loading poll. Retrying...</h2>';
        }
    }

    function displayPoll(poll) {
        currentPollDiv.innerHTML = `
            <h2>Current Poll</h2>
            <p><strong>${poll.question}</strong></p>
            <div class="poll-options">
              ${poll.options.map((option, index) => `
                <button onclick="vote(${index})">${option}</button>
              `).join('')}
            </div>
            <p><small>A new path will be chosen soon...</small></p>
        `;
    }

    async function vote(choiceIndex) {
        if (!currentPoll) return;

        currentPollDiv.innerHTML = `
            <h2>Thank you for voting!</h2>
            <p>The Bald Brothers' destiny is being forged...</p>
            <p>Generating next chapter...</p>
            <div id="next-chapter-countdown">Next chapter in 10 seconds...</div>
        `;

        try {
            await fetch(`/polls/${currentPoll.id}/vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ choice: choiceIndex })
            });

            // Wait for backend to process and start a new cycle
            setTimeout(() => {
                location.reload(); // Simple solution: reload the page to get the new state
            }, 10000); // 10 seconds

        } catch (error) {
            console.error('Error submitting vote:', error);
            alert('Failed to submit vote. Please try again.');
            fetchOpenPoll(); // Re-load the poll on failure
        }
    }

    // --- Initial Load ---

    function initialize() {
        storyHeading.textContent = 'Loading The Saga...';
        currentPollDiv.innerHTML = '<h2>Loading...</h2>';
        
        fetchLatestChapter();
        fetchOpenPoll();
    }
    
    // Remove the old countdown logic from the body
    const initialCountdownDiv = document.getElementById('countdown');
    if(initialCountdownDiv) initialCountdownDiv.style.display = 'none';

    initialize();
  </script>
</body>
</html> 